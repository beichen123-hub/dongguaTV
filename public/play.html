<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在播放...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; }
        #dplayer { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="dplayer"></div>

    <script>
        // 1. 从 URL 获取参数 (视频链接、ID、片名)
        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = urlParams.get('url');
        const videoId = urlParams.get('id'); 
        
        if (videoUrl) {
            initPlayer(videoUrl, videoId);
        } else {
            alert('未找到视频链接');
        }

        function initPlayer(url, id) {
            // 2. 请求后端获取弹幕 API 地址
            fetch('/api/config')
                .then(res => res.json())
                .then(config => {
                    const api = config.danmaku_api;
                    
                    // 3. 配置 DPlayer
                    const options = {
                        container: document.getElementById('dplayer'),
                        autoplay: true,
                        video: {
                            url: url,
                            type: 'hls',
                        }
                    };

                    // 如果有 API，启用弹幕
                    if (api) {
                        options.danmaku = {
                            id: id, // 使用 URL 传过来的 ID
                            api: api,
                            user: 'User',
                            bottom: '15%',
                            unlimited: true
                        };
                    }

                    new DPlayer(options);
                });
        }
    </script>
</body>
</html>
